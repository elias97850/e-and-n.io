<!DOCTYPE html>
<html class="light" lang="es"> <!-- Cambiado a 'es' -->
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Nuestro Primer A침o</title> <!-- Traducido -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    
    <!-- Fuentes para el Popup y la App -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet" />
    
    <!-- Carga principal de Iconos de Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <!-- A칌ADIDO: Tone.js para la m칰sica -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        .font-serif-display {
            font-family: 'Playfair Display', serif;
        }

        .font-script {
            font-family: 'Dancing Script', cursive;
        }
        
        /* FIX: Asegurar que todos los 'material-symbols-outlined' usen la fuente correcta */
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined';
        }

        /* Estilo para el nuevo 칤cono de flecha */
        .material-symbols-outlined.icon-arrow-back-style {
            font-variation-settings:
                'FILL' 1,
                'wght' 700,
                'GRAD' 0,
                'opsz' 48;
            font-size: 40px; /* M치s grande para ser m치s 'thick' */
        }
        
        /* Ocultar barra de scroll en main */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

        .strawberry {
            position: absolute;
            top: -50px;
            /* Empezar fuera de la pantalla */
            font-size: 2rem;
            user-select: none;
            animation: fall linear;
            z-index: 50;
            opacity: 1;
            /* Siempre opacidad 100% */
        }

        @keyframes fall {
            from {
                transform: translateY(0vh) rotate(0deg);
            }

            to {
                transform: translateY(105vh) rotate(360deg);
                /* Caer hasta abajo */
            }
        }

        .strawberry-heart-piece {
            position: absolute;
            font-size: 2rem;
            transform-origin: center;
            z-index: 100;
            /* Iniciar invisible y centrado para la animaci칩n fadeIn */
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
            /* Corregido: centrar desde el inicio */
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
                /* Corregido: mantener el centrado */
            }
        }

        /* Estilo para el cursor 'grabbing' del modal */
        #heartModalContainer.grabbing {
            cursor: grabbing;
        }

        /* Animaciones del Modal del Coraz칩n 3D */
        .modal-hidden {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 300ms ease-out, transform 300ms ease-out;
            pointer-events: none;
        }
        .modal-visible {
            opacity: 1;
            transform: scale(1);
            transition: opacity 300ms ease-in, transform 300ms ease-in;
        }
    </style>
    
    <script id="tailwind-config">
        tailwind.config = {
             darkMode: "class", // Habilitar dark mode si se usa
            theme: {
                extend: {
                    colors: {
                        // Colores de la App (unificados)
                        "primary": "#a65eed", // Tono violeta principal
                        "background-light": "#f7f6f8", // Fondo claro de la App
                        "background-dark": "#191121", // Fondo oscuro (si se usa)

                        // Colores del Popup (fusionados)
                        "primary-darker": "#9370DB",
                        "accent-gold": "#F0E68C",
                        "pastel-purple": "#D1C4E9",
                        "dark-purple": "#673AB7",
                        "text-light": "#333333",
                        "text-dark": "#F5F5F5",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"],
                        "script": ["Dancing Script", "cursive"],
                        "serif-display": ['Playfair Display', 'serif']
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                    keyframes: {
                        // Keyframes del Popup
                        fadeIn: {
                            '0%': { opacity: 0, transform: 'translateY(10px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' },
                        },
                        fadeInUp: {
                            '0%': { opacity: 0, transform: 'translateY(20px) scale(0.95)' },
                            '100%': { opacity: 1, transform: 'translateY(0) scale(1)' },
                        },
                        backdropIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 },
                        },
                        backgroundPulse: {
                            '0%, 100%': { filter: 'brightness(1) blur(6px)' },
                            '50%': { filter: 'brightness(1.1) blur(8px)' },
                        },
                        // A칌ADIDO: Animaci칩n de salida para el popup
                        fadeOut: {
                            'from': { opacity: 1 },
                            'to': { opacity: 0 }
                        },
                    },
                    animation: {
                        // Animaciones del Popup
                        fadeIn: 'fadeIn 1s ease-out forwards',
                        fadeInUp: 'fadeInUp 0.5s ease-out forwards',
                        backdropIn: 'backdropIn 0.5s ease-out forwards',
                        backgroundPulse: 'backgroundPulse 12s ease-in-out infinite',
                        fadeOut: 'fadeOut 0.5s ease-out forwards', // A칌ADIDO
                    },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        /* Estilos del Popup (Tailwind) */
        :root {
            --popup-bg-color: #FFFFFF;
            --popup-text-color: #3C3C5C;
            --secondary-text-color: #6C6C8E;
            --highlight-color: #A78BFA;
            --button-bg-color: #8B5CF6;
            --button-hover-bg: #7C3AED;
            --button-text-color: #FFFFFF;
            --background-image: url('https://source.unsplash.com/random/800x1200/?romantic,abstract,memory,landscape');
        }
        .popup-box-bg {
            background-color: var(--popup-bg-color);
            color: var(--popup-text-color);
        }
        .popup-text-secondary {
            color: var(--secondary-text-color);
        }
        .popup-highlight {
            color: var(--highlight-color);
        }
    </style>
</head>

<body class="font-display bg-zinc-100 flex justify-center items-center p-0 sm:p-4 overflow-hidden"> 
    
    <!-- ===== POPUP INICIAL (NUEVO ESTILO) ===== -->
    <div class="group/design-root fixed inset-0 z-50 flex h-dvh w-full items-center justify-center p-6 animate-backdropIn" id="welcome-popup">
        <div class="absolute inset-0 bg-[var(--background-image)] bg-cover bg-center animate-backgroundPulse" style="background-image: url('https://images.unsplash.com/photo-1531685250784-75b9f106852e?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNjc5fDB8MHxwaG90by1yZWxhdGVkfDE5fHx8ZW58MHx8fHx8&ixlib=rb-4.0.3&q=80&w=1080');"></div>
        <div class="absolute inset-0 bg-black/30 backdrop-blur-md"></div>
        <div class="relative w-full max-w-sm animate-fadeInUp rounded-xl popup-box-bg shadow-2xl shadow-purple-500/30">
            <div class="relative flex flex-col items-center justify-center p-8 text-center">
                <div class="mb-4">
                    <span class="material-symbols-outlined text-5xl popup-highlight">favorite</span>
                </div>
                <h1 class="font-script text-[var(--popup-text-color)] text-4xl font-bold tracking-tight leading-tight">
                    Un A침o de Nuestro Hermoso Viaje <!-- Traducido -->
                </h1>
                <div class="mt-8 mb-4 text-lg">
                    <p class="popup-text-secondary font-bold">Para mi amada:</p> <!-- Traducido -->
                    <p class="font-script text-3xl font-bold text-primary-darker mt-1.5">Nurialys Castillo Alers</p>
                </div>
                <p class="mt-6 mb-2 text-lg font-bold">
                    <span class="bg-[#F5F3F7] text-[#673AB7] px-6 py-3 rounded-full tracking-wider" style="box-shadow: 6px 6px 12px #e0dde4, -6px -6px 12px #ffffff, inset 2px 2px 4px #e0dde4, inset -2px -2px 4px #ffffff;">Noviembre 23 2025</span>
                </p>
                <!-- Bot칩n adaptado a <button> para que funcione el JS -->
                <button id="closePopup" class="mt-8 flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-14 px-5 bg-[var(--button-bg-color)] text-[var(--button-text-color)] text-xl font-bold tracking-[0.015em] shadow-lg shadow-purple-500/30 transition-all duration-200 ease-in-out active:scale-95 hover:bg-[var(--button-hover-bg)]">
                    <span class="truncate font-bold">TE AMO</span> <!-- Mantenido -->
                </button>
            </div>
        </div>
    </div>

    <!-- ===== APLICACI칍N PRINCIPAL (Oculta al inicio) ===== -->
    <div id="main-content-wrapper" class="relative flex h-dvh w-full max-w-md flex-col bg-background-light group/design-root overflow-x-hidden sm:shadow-2xl sm:rounded-2xl" style="display: none;">
        
        <div class="flex items-center bg-transparent p-4 pb-2 justify-between text-zinc-900">
            <div class="flex w-12 shrink-0 items-center justify-start">
                <!-- Bot칩n para ABRIR el modal del coraz칩n 3D -->
                <button id="heartButton" class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 w-12 bg-transparent gap-2 text-base font-bold leading-normal tracking-[0.015em] min-w-0 p-0 hover:bg-primary/10 transition-colors">
                    <span class="text-2xl">仇벒잺</span>
                </button>
            </div>
            <h2 class="text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Mil A침os M치s</h2> <!-- Traducido -->
            <div class="flex w-12 items-center justify-end">
                <!-- Bot칩n de Fresa -->
                <button id="strawberryButton" class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 w-12 bg-transparent gap-2 text-base font-bold leading-normal tracking-[0.015em] min-w-0 p-0 hover:bg-primary/10 transition-colors">
                    <span class="text-2xl">游꼡</span>
                </button>
            </div>
        </div>

        <!-- Contenedor principal de la lista (scrollable) -->
        <main class="flex flex-1 flex-col overflow-y-auto px-4 pb-4 scrollbar-hide">
            
            <!-- Countdown (movido dentro del <main>) -->
            <div class="relative mb-6 mt-4 rounded-xl border-4 border-primary/50 bg-white p-3 shadow-lg flex flex-col items-center justify-center text-center text-zinc-900">
                <div class="absolute inset-0 scale-105 bg-primary/20 rounded-xl blur-2xl opacity-60"></div>
                <div class="relative z-10 w-full flex flex-col items-center justify-center">
                    <p class="text-sm font-medium text-primary mb-1">Nuestro pr칩ximo aniversario</p> <!-- Traducido -->
                    <div class="flex items-baseline justify-center gap-x-1.5 text-zinc-900 flex-wrap px-2">
                        <!-- IDs para el countdown -->
                        <span id="countdown-days" class="text-2xl font-bold tracking-tighter">0</span><span class="text-sm font-medium text-zinc-500">d</span>
                        <span id="countdown-hours" class="text-2xl font-bold tracking-tighter">0</span><span class="text-sm font-medium text-zinc-500">h</span>
                        <span id="countdown-minutes" class="text-2xl font-bold tracking-tighter">0</span><span class="text-sm font-medium text-zinc-500">m</span>
                        <span id="countdown-seconds" class="text-2xl font-bold tracking-tighter">0</span><span class="text-sm font-medium text-zinc-500">s</span>
                    </div>
                    <div class="mt-3 w-full bg-primary/10 rounded-md py-2 px-4 text-sm text-zinc-700">
                        <p>Celebrando cada precioso momento.</p> <!-- Traducido -->
                    </div>
                </div>
            </div>

            <!-- Lista de tarjetas (AHORA SE GENERA CON JS) -->
            <!-- Le damos un ID para seleccionarlo f치cilmente -->
            <div id="memories-list-container" class="grid grid-cols-1 gap-6 py-4">
                <!-- Las tarjetas se cargar치n aqu칤... -->
            </div>

        </main>

        <!-- Contenedores de Animaciones -->
        <div id="rain-container" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
        <div id="heart-container" class="absolute inset-0 flex items-center justify-center pointer-events-none"></div>

    </div>

    <!-- ===== MODAL DEL CORAZ칍N 3D ===== -->
    <!-- Fondo del Modal (con animaci칩n) -->
    <div id="heartModalBackdrop" class="fixed inset-0 bg-zinc-100 flex justify-center items-center p-0 sm:p-4 modal-hidden" style="z-index: 100; overflow: hidden;">
        
        <!-- Contenedor del Modal (layout de app) -->
        <div id="heartModalContainer" class="relative flex h-dvh w-full max-w-md flex-col bg-background-light group/design-root overflow-x-hidden sm:shadow-2xl sm:rounded-2xl" style="cursor: grab;">
            
            <!-- Bot칩n de cerrar movido a la izquierda con 칤cono -->
            <button id="closeHeartModal" class="absolute top-4 left-4 text-primary" style="z-index: 101; -webkit-user-select: none; user-select: none; opacity: 0.7; padding: 0.75rem; /* 츼rea de toque aumentada */">
                 <span class="material-symbols-outlined icon-arrow-back-style">arrow_back_2</span>
            </button>
            
            <!-- Contenedor del Coraz칩n 3D -->
            <div class="flex-1 grid place-items-center overflow-hidden">
                <pre id="heart-display" style="font-family: 'Courier New', Courier, monospace; font-size: 12px; font-weight: 900; line-height: 1.0; text-align: center; color: #a65eed; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;"></pre>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // === L칍GICA DEL POPUP INICIAL ===
            const popup = document.getElementById('welcome-popup');
            const closePopupButton = document.getElementById('closePopup');
            const mainContent = document.getElementById('main-content-wrapper');
            
            // A칌ADIDO: Inicializar el sintetizador de Tone.js
            const synth = new Tone.Synth().toDestination();
            const melody = [
                ['C4', '8n'], ['E4', '8n'], ['G4', '8n'], ['C5', '4n']
            ];

            // NUEVO: Sintetizador para un sonido de clic limpio y moderno
            const clickSynth = new Tone.Synth({
                oscillator: {
                    type: "sine" // Onda sinusoidal limpia
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.01,
                    sustain: 0,
                    release: 0.05 // Muy corto
                }
            }).toDestination();

            // NUEVO: Sintetizador para el sonido "bubble pop" (reemplaza explosionSynth)
            const popSynth = new Tone.MembraneSynth({
                pitchDecay: 0.01, // Ca칤da de tono muy r치pida
                octaves: 4,       // Rango de la ca칤da de tono
                oscillator: {
                    type: "sine"  // Tono limpio
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,   // Sonido corto
                    sustain: 0,
                    release: 0.05
                }
            }).toDestination();


            // NUEVO: Funci칩n para reproducir el sonido de clic
            function playClickSound() {
                try {
                    // Tocar una nota corta y aguda
                    clickSynth.triggerAttackRelease("C6", "50n");
                } catch (e) {
                    console.error("Error al reproducir el sonido de clic:", e);
                }
            }

            // NUEVO: Funci칩n para reproducir el sonido "pop" (reemplaza playExplosionSound)
            function playExplosionSound() {
                try {
                    const now = Tone.now();
                    // Tocar una nota aguda que caer치 r치pido para el "pop"
                    popSynth.triggerAttackRelease("G4", "32n", now);
                } catch (e) {
                    console.error("Error al reproducir el sonido de explosi칩n:", e);
                }
            }


            if (popup && closePopupButton && mainContent) {
                // CORREGIDO: Cambiado de ()async => a async () =>
                closePopupButton.addEventListener('click', async () => {
                    
                    // A칌ADIDO: Iniciar el audio y tocar la melod칤a
                    try {
                        await Tone.start(); // Pedir permiso de audio
                        playClickSound();

                    } catch (e) {
                        console.error("Error al reproducir audio:", e);
                    }

                    // Ocultar el popup con la animaci칩n de fade-out
                    popup.classList.remove('animate-backdropIn'); // Quitar animaci칩n de entrada
                    popup.classList.add('animate-fadeOut'); // A침adir animaci칩n de salida
                    
                    setTimeout(() => {
                        popup.style.display = 'none';
                        // Mostrar el contenido principal
                        mainContent.style.display = 'flex';
                        
                        // Cargar las memorias DESPU칄S de mostrar el contenido principal
                        loadMemories(); 
                    }, 500); // Sincronizar con la transici칩n
                });
            } else {
                console.error("No se encontraron los elementos del popup o del contenido principal.");
                // Si algo falla, ocultar el popup y mostrar la app para que no se bloquee
                if (popup) popup.style.display = 'none';
                if (mainContent) mainContent.style.display = 'flex';
                // Cargar memorias incluso si el popup falla
                loadMemories();
            }

            // === L칍GICA DE CARGA DE MEMORIAS (NUEVO) ===

            /**
             * Convierte una URL de Google Drive 'view' a una URL de imagen directa.
             * @param {string} driveURL - La URL de Google Drive (ej. .../file/d/FILE_ID/view)
             * @returns {string} La URL de la imagen directa (ej. https://lh3.googleusercontent.com/d/FILE_ID)
             */
            function getGoogleDriveImageURL(driveURL) {
                // Expresi칩n regular para extraer el FILE_ID de varios formatos de URL de Drive
                const fileIdMatch = driveURL.match(/file\/d\/([a-zA-Z0-9_-]{28,})/);
                if (fileIdMatch && fileIdMatch[1]) {
                    const fileId = fileIdMatch[1];
                    return `https://lh3.googleusercontent.com/d/${fileId}`;
                }
                
                // Fallback por si la URL ya es directa o tiene otro formato (aunque para tu JSON, la de arriba funcionar치)
                console.warn("No se pudo extraer el File ID de:", driveURL, ". Usando la URL original.");
                return driveURL;
            }

            /**
             * Carga las memorias desde el JSON y las muestra en la p치gina.
             */
            // 춰CAMBIO! Se restaur칩 'async' para que funcione 'await fetch'
            async function loadMemories() {
                
                // 춰CAMBIO! Esta es la URL relativa que funcionar치 en GitHub Pages
                // porque 'memories.json' est치 en la misma carpeta.
                const memoriesURL = './memories.json'; 

                // 춰CAMBIO! Se elimin칩 el array 'const memories = [...]' de aqu칤.

                const container = document.getElementById('memories-list-container');
                if (!container) {
                    console.error('Error: No se encontr칩 el contenedor "memories-list-container".');
                    return;
                }

                // Mostrar un estado de carga
                container.innerHTML = '<p class="text-center text-zinc-500">Cargando recuerdos...</p>';

                try {
                    
                    // 춰CAMBIO! Se restaur칩 la l칩gica de 'fetch'
                    const response = await fetch(memoriesURL);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const memories = await response.json();

                    // Limpiar el contenedor (quitar el "Cargando...")
                    container.innerHTML = '';

                    // Crear y a침adir cada tarjeta
                    memories.forEach((memory, index) => { // A침adido 'index' para el delay
                        // Convertir la URL de Google Drive
                        const imageSrc = getGoogleDriveImageURL(memory.image);
                        
                        // --- 춰NUEVO! ---
                        // Obtener valores de zoom y offset, con valores por defecto
                        const zoom = memory.zoom || 1;
                        const offsetX = memory.offsetX || '50%';
                        const offsetY = memory.offsetY || '50%';
                        // --- FIN DE LO NUEVO ---

                        // Crear el HTML de la tarjeta
                        const cardHTML = `
                            <div class="w-full bg-white shadow-md rounded-lg overflow-hidden animate-fadeInUp" style="animation-delay: ${index * 100}ms"> <!-- Delay escalonado -->
                                <!-- Contenedor de la imagen (m치s alto que antes) -->
                                <!-- 춰NUEVO! Se a침adi칩 overflow-hidden aqu칤 -->
                                <div class="w-full h-48 bg-zinc-200 overflow-hidden">
                                    <!-- 춰NUEVO! Se a침adieron estilos en l칤nea para zoom y object-position -->
                                    <img src="${imageSrc}" 
                                         alt="${memory.title}" 
                                         class="w-full h-full object-cover transition-transform duration-300 ease-out hover:scale-105" 
                                         style="transform: scale(${zoom}); object-position: ${offsetX} ${offsetY};"
                                         onerror="this.src='https://placehold.co/600x400/f7f6f8/a65eed?text=Error:('; this.alt='Error al cargar imagen';">
                                </div>
                                <!-- Contenido de texto -->
                                <div class="p-4">
                                    <p class="text-xs text-zinc-500 mb-1">${memory.date}</p>
                                    <h3 class="font-semibold text-zinc-900">${memory.title}</h3>
                                    <p class="text-sm text-zinc-700 mt-2">${memory.subtitle}</p>
                                </div>
                            </div>
                        `;
                        // A침adir la tarjeta al contenedor
                        container.innerHTML += cardHTML;
                    });

                } catch (error) {
                    // 춰CAMBIO! El mensaje de error ahora es para el 'fetch'
                    console.error('Error al cargar el archivo JSON de memorias:', error);
                    container.innerHTML = '<p class="text-center text-red-500">No se pudieron cargar los recuerdos. Revisa la URL del JSON.</p>';
                }
            }


            // === L칍GICA DEL COUNTDOWN ===
            const targetDate = new Date("2026-11-25T00:00:00").getTime();
            const daysEl = document.getElementById('countdown-days');
            const hoursEl = document.getElementById('countdown-hours');
            const minutesEl = document.getElementById('countdown-minutes');
            const secondsEl = document.getElementById('countdown-seconds');

            function updateCountdown() {
                if (!daysEl || !hoursEl || !minutesEl || !secondsEl) return;

                const now = new Date().getTime();
                const distance = targetDate - now;

                if (distance < 0) {
                    daysEl.innerText = "0";
                    hoursEl.innerText = "0";
                    minutesEl.innerText = "0";
                    secondsEl.innerText = "0";
                    clearInterval(countdownInterval);
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                daysEl.innerText = days;
                hoursEl.innerText = hours;
                minutesEl.innerText = minutes;
                secondsEl.innerText = seconds;
            }
            // Actualizar inmediatamente y luego cada segundo
            updateCountdown();
            const countdownInterval = setInterval(updateCountdown, 1000);


            // === L칍GICA DEL CORAZ칍N DE FRESAS ===
            const strawberryButton = document.getElementById('strawberryButton');
            const rainContainer = document.getElementById('rain-container');
            const heartContainer = document.getElementById('heart-container');

            let consecutiveClicks = 0;
            let clickTimer = null;

            const animationStyleSheetEl = document.createElement('style');
            animationStyleSheetEl.type = 'text/css';
            document.head.appendChild(animationStyleSheetEl);
            const styleSheet = animationStyleSheetEl.sheet;

            if (strawberryButton && rainContainer && heartContainer) {
                strawberryButton.addEventListener('click', () => {
                    playClickSound(); // <-- A칌ADIDO
                    consecutiveClicks++;
                    if (clickTimer) clearTimeout(clickTimer);

                    if (consecutiveClicks === 10) {
                        heartContainer.innerHTML = '';
                        createStrawberryHeart();
                        consecutiveClicks = 0;
                    } else {
                        for (let i = 0; i < 15; i++) {
                            createFallingStrawberry();
                        }
                    }

                    clickTimer = setTimeout(() => {
                        consecutiveClicks = 0;
                    }, 2000);
                });
            }

            function createFallingStrawberry() {
                const strawberry = document.createElement('div');
                strawberry.classList.add('strawberry');
                strawberry.innerText = '游꼡';

                strawberry.style.left = `${Math.random() * 100}%`;
                const duration = Math.random() * 2 + 1;
                strawberry.style.animationDuration = `${duration}s`;
                strawberry.style.animationDelay = `${Math.random() * 1}s`;
                strawberry.style.fontSize = `${Math.random() * 1.5 + 1}rem`;
                strawberry.style.opacity = `1`;

                rainContainer.appendChild(strawberry);

                setTimeout(() => {
                    strawberry.remove();
                }, (duration + 1) * 1000);
            }

            function createStrawberryHeart() {
                const heartPattern = [
                    "    * * * * * *",
                    "   * * * * * * * *",
                    "  * * * * * * * * * *",
                    "  * * * * * * * * * *",
                    " * * * * * * * * * * * *",
                    "* * * * * * * * * * * * * *",
                    "* * * * * * * * * * * * * *",
                    "* * * * * * * * * * * * * *",
                    "* * * * * * * * * * * * * *",
                    " * * * * * * * * * * * * *",
                    " * * * * * * * * * * * * *",
                    "   * * * * * * * * * * *",
                    "   * * * * * * * * * * *",
                    "     * * * * * * * * *",
                    "     * * * * * * * * *",
                    "       * * * * * * *",
                    "       * * * * * * *",
                    "         * * * * *",
                    "         * * * * *",
                    "           * * *",
                    "            * *",
                    "             *"
                ];

                const scale = 13; // Hecho m치s compacto
                const strawberrySize = 1.9;
                const delayBetweenFresas = 10; // Dibujar r치pido

                const maxWidth = heartPattern.reduce((max, r) => Math.max(max, r.length), 0);
                const totalStars = heartPattern.join('').replace(/ /g, '').length;
                let starsPlaced = 0;

                heartPattern.forEach((row, rowIndex) => {
                    for (let i = 0; i < row.length; i++) {
                        if (row[i] === '*') {
                            setTimeout(() => {
                                const strawberry = document.createElement('div');
                                strawberry.classList.add('strawberry-heart-piece');
                                strawberry.innerText = '游꼡';

                                const xOffset = (i - (maxWidth - 1) / 2) * scale;
                                const yOffset = (rowIndex - (heartPattern.length - 1) / 2) * scale;

                                strawberry.style.left = `calc(50% + ${xOffset}px)`;
                                strawberry.style.top = `calc(50% + ${yOffset}px)`;
                                strawberry.style.fontSize = `${strawberrySize}rem`;
                                heartContainer.appendChild(strawberry);

                                starsPlaced++;

                                if (starsPlaced === totalStars) {
                                    // Esperar 750ms despu칠s de DIBUJAR la 칰ltima fresa
                                    setTimeout(explodeHeart, 750); 
                                }
                            }, starsPlaced * delayBetweenFresas); // Usar el contador para el retraso
                        }
                    }
                });
            }

            function explodeHeart() {
                playExplosionSound(); // <-- A칌ADIDO (reemplaza playSparkleSound)
                const strawberries = heartContainer.querySelectorAll('.strawberry-heart-piece');
                strawberries.forEach((strawberry, index) => {
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * 200 + 100;
                    const translateX = distance * Math.cos(angle);
                    const translateY = distance * Math.sin(angle);
                    const rotation = Math.random() * 720 - 360;

                    const keyframesName = `explode-strawberry-${index}`;

                    try {
                        styleSheet.insertRule(`
                            @keyframes ${keyframesName} {
                                from {
                                    transform: translate(-50%, -50%) scale(1);
                                    opacity: 1;
                                    filter: blur(0);
                                }
                                to {
                                    transform: translate(calc(-50% + ${translateX}px), calc(-50% + ${translateY}px)) rotate(${rotation}deg) scale(1);
                                    opacity: 0;
                                    filter: blur(2px);
                                }
                            }
                        `, styleSheet.cssRules.length);

                        strawberry.style.animation = `${keyframesName} 1.5s ease-out forwards`;
                    } catch (e) {
                        console.warn("Error insertando regla CSS (ignorable si son pocas):", e.message);
                        strawberry.remove(); // Limpiar si falla la animaci칩n
                    }


                    setTimeout(() => {
                        strawberry.remove();
                        // Limpiar la regla de keyframes
                        try {
                            for (let i = 0; i < styleSheet.cssRules.length; i++) {
                                if (styleSheet.cssRules[i] && styleSheet.cssRules[i].name === keyframesName) {
                                    styleSheet.deleteRule(i);
                                    break;
                                }
                            }
                        } catch (e) {
                           // Ignorar errores al limpiar (puede pasar si la hoja de estilos est치 ocupada)
                        }
                    }, 1500);
                });
            }

            // === L칍GICA DEL CORAZ칍N 3D ===

            // --- Referencias a elementos del Modal ---
            const heartButton = document.getElementById('heartButton');
            const heartModalBackdrop = document.getElementById('heartModalBackdrop');
            const closeHeartModal = document.getElementById('closeHeartModal');
            const heartDisplayPre = document.getElementById('heart-display');
            const heartModalContainer = document.getElementById('heartModalContainer'); 

            if (heartButton && heartModalBackdrop && closeHeartModal && heartDisplayPre && heartModalContainer) {

                // --- Constantes y variables globales del Coraz칩n 3D ---
                const PI = Math.PI;
                const LUMINANCE = ".,-~:;=!*#$@"; // 12 caracteres

                let SCREEN_WIDTH, SCREEN_HEIGHT;
                let output, zbuffer;

                let heart_angleA = 0; // 츼ngulo de rotaci칩n X
                let heart_angleB = 0; // 츼ngulo de rotaci칩n Y

                let heart_animationId = null; // Para iniciar/detener el loop

                // --- Variables para control de mouse/touch ---
                let heart_isDragging = false;
                let heart_lastMouseX = 0;
                let heart_lastMouseY = 0;

                // --- Funciones de Math ---
                const cos = Math.cos;
                const sin = Math.sin;
                const sqrt = Math.sqrt;

                /**
                 * Inicializa (o reinicializa) los buffers con el tama침o del modal.
                 */
                function setupBuffers() {
                    const charWidth = 8; // Ancho (Courier 12px 900)
                    const charHeight = 12; // Alto (font-size 12px)

                    SCREEN_WIDTH = Math.floor(heartModalContainer.clientWidth / charWidth); 
                    SCREEN_HEIGHT = Math.floor(heartModalContainer.clientHeight / charHeight); 
                    
                    if (SCREEN_WIDTH <= 0 || SCREEN_HEIGHT <= 0) {
                        SCREEN_WIDTH = 80; // Default
                        SCREEN_HEIGHT = 40; // Default
                    }

                    output = Array(SCREEN_HEIGHT).fill(0).map(() => Array(SCREEN_WIDTH).fill(' '));
                    zbuffer = Array(SCREEN_HEIGHT).fill(0).map(() => Array(SCREEN_WIDTH).fill(-Infinity));
                }

                /**
                 * Renderiza un frame del coraz칩n 3D.
                 */
                function renderFrame(A, B) {
                    const cosA = cos(A), sinA = sin(A);
                    const cosB = cos(B), sinB = sin(B);

                    for (let i = 0; i < SCREEN_HEIGHT; i++) {
                        for (let j = 0; j < SCREEN_WIDTH; j++) {
                            output[i][j] = ' ';
                            zbuffer[i][j] = -Infinity;
                        }
                    }

                    for (let u = 0; u < 2 * PI; u += 0.04) { 
                        for (let v = 0; v < PI; v += 0.04) { 

                            // Ecuaciones param칠tricas (versi칩n original/peque침a)
                            let x = sin(v) * (15 * sin(u) - 4 * sin(3 * u));
                            let y = 8 * cos(v);
                            let z = sin(v) * (15 * cos(u) - 5 * cos(2 * u) - 2 * cos(3 * u) - cos(4 * u));

                            let x1 = x * cosB + z * sinB;
                            let y1 = y;
                            let z1 = -x * sinB + z * cosB;

                            let x_rot = x1;
                            let y_rot = y1 * cosA - z1 * sinA;
                            let z_rot = y1 * sinA + z1 * cosA;

                            // Proyecci칩n
                            let z_offset = 40; // Zoom in (reducido de 70 -> 50 -> 40)
                            let ooz = 1 / (z_rot + z_offset); 
                            
                            let xp = Math.floor(SCREEN_WIDTH / 2 + x_rot * ooz * SCREEN_WIDTH * 0.5);
                            let yp = Math.floor(SCREEN_HEIGHT / 2 - y_rot * ooz * SCREEN_HEIGHT * 0.5);

                            // Normales
                            let nx = sin(v) * (15 * cos(u) - 4 * cos(3 * u));
                            let ny = 8 * -sin(v) * sin(v);
                            let nz = cos(v) * (15 * sin(u) - 5 * sin(2 * u) - 2 * sin(3 * u) - sin(4 * u));

                            let nx1 = nx * cosB + nz * sinB;
                            let ny1 = ny;
                            let nz1 = -nx * sinB + nz * cosB;

                            let nx_rot = nx1;
                            let ny_rot = ny1 * cosA - nz1 * sinA;
                            let nz_rot = ny1 * sinA + nz1 * cosA;



                            let length = sqrt(nx_rot * nx_rot + ny_rot * ny_rot + nz_rot * nz_rot);
                            nx_rot /= length;
                            ny_rot /= length;
                            nz_rot /= length;

                            let lx = 0;
                            let ly = 0;
                            let lz = -1; 

                            let L = nx_rot * lx + ny_rot * ly + nz_rot * lz;
                            
                            let luminance_index = Math.floor((L + 1) * 5.5);

                            if (xp >= 0 && xp < SCREEN_WIDTH && yp >= 0 && yp < SCREEN_HEIGHT) {
                                if (ooz > zbuffer[yp][xp]) {
                                    zbuffer[yp][xp] = ooz;
                                    luminance_index = luminance_index < 0 ? 0 : (luminance_index > 11 ? 11 : luminance_index);
                                    output[yp][xp] = LUMINANCE[luminance_index];
                                }
                            }
                        }
                    }
                }

                /**
                 * Bucle de animaci칩n del coraz칩n
                 */
                function heartLoop() {
                    if (!heart_isDragging) {
                        heart_angleA += 0.02; // M치s lento
                        heart_angleB += 0.0075; // M치s lento
                    }

                    renderFrame(heart_angleA, heart_angleB);

                    let outputString = "";
                    for (let i = 0; i < SCREEN_HEIGHT; i++) {
                        outputString += output[i].join('');
                        outputString += '\n';
                    }
                    heartDisplayPre.textContent = outputString;

                    heart_animationId = requestAnimationFrame(heartLoop);
                }

                // --- Event Listeners para Abrir/Cerrar Modal ---

                function openModal() {
                    heartModalBackdrop.classList.remove('modal-hidden');
                    heartModalBackdrop.classList.add('modal-visible');
                    document.body.style.overflow = 'hidden'; 
                    setupBuffers(); 
                    if (heart_animationId) cancelAnimationFrame(heart_animationId); 
                    heartLoop(); 
                }

                function closeModal() {
                    heartModalBackdrop.classList.remove('modal-visible');
                    heartModalBackdrop.classList.add('modal-hidden');
                    document.body.style.overflow = ''; 
                    if (heart_animationId) {
                        cancelAnimationFrame(heart_animationId); 
                        heart_animationId = null;
                    }
                }

                // Abrir el modal
                heartButton.addEventListener('click', openModal);
                heartButton.addEventListener('click', playClickSound); // <-- A칌ADIDO

                // Cerrar el modal (con click y touch)
                closeHeartModal.addEventListener('click', closeModal);
                closeHeartModal.addEventListener('click', playClickSound); // <-- A칌ADIDO
                closeHeartModal.addEventListener('touchstart', (e) => {
                    e.preventDefault(); // Evitar "click" fantasma
                    playClickSound(); // <-- A칌ADIDO
                    closeModal();
                }, { passive: false });


                // --- Listeners de Mouse (Rotaci칩n) ---
                heartModalContainer.addEventListener('mousedown', (e) => { 
                    if (e.target === closeHeartModal || closeHeartModal.contains(e.target)) return; // No arrastrar si se hace clic en el bot칩n
                    heart_isDragging = true;
                    heart_lastMouseX = e.clientX;
                    heart_lastMouseY = e.clientY;
                    heartModalContainer.classList.add('grabbing'); 
                    e.preventDefault(); 
                });

                heartModalContainer.addEventListener('mousemove', (e) => { 
                    if (!heart_isDragging) return;
                    const deltaX = e.clientX - heart_lastMouseX;
                    const deltaY = e.clientY - heart_lastMouseY;
                    heart_angleB += deltaX * 0.005;
                    heart_angleA -= deltaY * 0.005; 
                    heart_lastMouseX = e.clientX;
                    heart_lastMouseY = e.clientY;
                });

                heartModalContainer.addEventListener('mouseup', () => { 
                    heart_isDragging = false;
                    heartModalContainer.classList.remove('grabbing'); 
                });

                heartModalContainer.addEventListener('mouseleave', (e) => { 
                    heart_isDragging = false;
                    heartModalContainer.classList.remove('grabbing'); 
                });

                // --- Listeners T츼CTILES (Rotaci칩n) ---
                heartModalContainer.addEventListener('touchstart', (e) => {
                    if (e.target === closeHeartModal || closeHeartModal.contains(e.target)) return; // No arrastrar si se toca el bot칩n
                    if (e.touches.length === 1) {
                        heart_isDragging = true;
                        heart_lastMouseX = e.touches[0].clientX;
                        heart_lastMouseY = e.touches[0].clientY;
                        heartModalContainer.classList.add('grabbing');
                        e.preventDefault();
                    }
                }, { passive: false });

                heartModalContainer.addEventListener('touchmove', (e) => {
                    if (!heart_isDragging || e.touches.length !== 1) return;
                    const deltaX = e.touches[0].clientX - heart_lastMouseX;
                    const deltaY = e.touches[0].clientY - heart_lastMouseY;
                    heart_angleB += deltaX * 0.005;
                    heart_angleA -= deltaY * 0.005;
                    heart_lastMouseX = e.touches[0].clientX;
                    heart_lastMouseY = e.touches[0].clientY;
                    e.preventDefault();
                }, { passive: false });

                heartModalContainer.addEventListener('touchend', () => {
                    heart_isDragging = false;
                    heartModalContainer.classList.remove('grabbing');
                });


                // Listener para redimensionar
                window.addEventListener('resize', () => {
                    if (heartModalBackdrop.classList.contains('modal-visible')) { 
                        setupBuffers();
                    }
                });

            } else {
                console.error("No se pudieron encontrar los elementos del modal del coraz칩n 3D.");
            }

        });
    </script>

</body>
</html>
